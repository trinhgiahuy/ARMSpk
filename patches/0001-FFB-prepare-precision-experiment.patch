From e42dc7ee0df0e0e459bc061baccf59db82188eba Mon Sep 17 00:00:00 2001
From: Jens Domke <domke.j.aa@m.titech.ac.jp>
Date: Fri, 23 Feb 2018 02:38:26 +0900
Subject: [PATCH 1/1] FFB: prepare precision experiment

Signed-off-by: Jens Domke <domke.j.aa@m.titech.ac.jp>
---
 .gitignore            |  2 ++
 src/Makefile          |  2 +-
 src/ffb_mini_main.F90 | 33 ++++++++++++++++++++++++++++++++-
 src/les3x.F           | 40 +++++++++++++++++++++++++++++++++++++---
 src/make_setting      |  5 +++--
 src/ssc.c             | 24 ++++++++++++++++++++++++
 6 files changed, 99 insertions(+), 7 deletions(-)
 create mode 100644 src/ssc.c

diff --git a/.gitignore b/.gitignore
index 32dbb91..7b1856c 100644
--- a/.gitignore
+++ b/.gitignore
@@ -4,6 +4,8 @@
 *.log
 *.a
 
+bin/
+
 src/param.h
 
 test/BOUN.*
diff --git a/src/Makefile b/src/Makefile
index 0f46f89..a5166c1 100644
--- a/src/Makefile
+++ b/src/Makefile
@@ -32,7 +32,7 @@ OBJS = \
   rfname.o sethex.o srfexx.o          subcnv.o \
            vel3d1.o vel3d2.o          \
   mfname.o \
-  miniapp_util.o
+  miniapp_util.o ssc.o
 
 ifeq (, $(findstring -DNO_METIS, $(FFLAGS)))
 OBJS += metis_wrapper.o
diff --git a/src/ffb_mini_main.F90 b/src/ffb_mini_main.F90
index 060f4d4..a4376af 100644
--- a/src/ffb_mini_main.F90
+++ b/src/ffb_mini_main.F90
@@ -1,7 +1,28 @@
 program ffb_mini
   use mpi
   use makemesh
+
+  use, intrinsic :: iso_c_binding
   implicit none
+  interface
+  integer function SSC_MARK_START ( i ) bind ( c )
+  integer :: i
+  !!!DEC$ ATTRIBUTES C:: SSC_MARK_START
+  end function
+  integer function SSC_MARK_START2 ( i ) bind ( c )
+  integer :: i
+  !!!DEC$ ATTRIBUTES C:: SSC_MARK_START2
+  end function
+  integer function SSC_MARK_STOP ( j ) bind ( c )
+  integer :: j
+  !!!DEC$ ATTRIBUTES C:: SSC_MARK_STOP
+  end function
+  integer function SSC_MARK_STOP2 ( j ) bind ( c )
+  integer :: j
+  !!!DEC$ ATTRIBUTES C:: SSC_MARK_STOP2
+  end function
+  end interface
+
 
   integer :: ierr
   include 'param.h'
@@ -30,9 +51,13 @@ program ffb_mini
   character(60) :: color_partsize = ""
   character(60) :: unroll = ""
 
+  integer :: sscfake = 1
+
   call MPI_Init(ierr)
   call MPI_Comm_rank(MPI_COMM_WORLD, myrank, ierr)
   call MPI_Comm_size(MPI_COMM_WORLD, nprocs, ierr)
+  if (myrank .eq. 0) sscfake = SSC_MARK_STOP(myrank)
+  if (myrank .ne. 0) sscfake = SSC_MARK_STOP2(myrank)
 
   narg = command_argument_count()
   if (narg < 4) call print_usage_and_exit
@@ -110,7 +135,13 @@ program ffb_mini
       write(*, '(/,a,/)') '... done'
   end if
 
-  call LES3X(file_parm)
+  call LES3X(file_parm, myrank)
+
+  if (myrank .eq. 0) sscfake = SSC_MARK_START(myrank)
+  if (myrank .ne. 0) sscfake = SSC_MARK_START2(myrank)
+  if (myrank == 0) then
+      write(*,*) sscfake
+  end if
 
 contains
 
diff --git a/src/les3x.F b/src/les3x.F
index bf9d6fa..8da3b68 100644
--- a/src/les3x.F
+++ b/src/les3x.F
@@ -15,10 +15,33 @@ C THERMO-FLUID ANALYSIS SOLVERS FOR LARGE-SCALE-ASSEMBLY               C
 C                                                                      C
 C======================================================================C
 C*    PROGRAM LES3X
-      SUBROUTINE LES3X(FILEIN)
+      SUBROUTINE LES3X(FILEIN,myrank)
 #include "timing.h"
-      IMPLICIT NONE 
-C
+      use, intrinsic :: iso_c_binding
+      IMPLICIT NONE
+      interface
+      integer function SSC_MARK_START ( i ) bind ( c )
+      integer :: i
+      !!!DEC$ ATTRIBUTES C:: SSC_MARK_START
+      end function
+      integer function SSC_MARK_START2 ( i ) bind ( c )
+      integer :: i
+      !!!DEC$ ATTRIBUTES C:: SSC_MARK_START2
+      end function
+      integer function SSC_MARK_STOP ( j ) bind ( c )
+      integer :: j
+      !!!DEC$ ATTRIBUTES C:: SSC_MARK_STOP
+      end function
+      integer function SSC_MARK_STOP2 ( j ) bind ( c )
+      integer :: j
+      !!!DEC$ ATTRIBUTES C:: SSC_MARK_STOP2
+      end function
+      end interface
+C
+      include 'mpif.h'
+      real(8) :: mkrts, mkrte
+      integer(4) :: sscfake = 1
+      INTEGER*4 myrank
       CHARACTER*(*) FILEIN
 C
       INTEGER*4 N0,N1,N2
@@ -1781,6 +1804,9 @@ C
       WRITE(IUT6,*) BLANK
       WRITE(IUT6,*) ' ** NOW ENTERING TIME MARCH LOOP **'
       TIME_START(TM_MAIN_LOOP)
+      mkrts = MPI_WTIME()
+      if (myrank .eq. 0) sscfake = SSC_MARK_START(myrank)
+      if (myrank .ne. 0) sscfake = SSC_MARK_START2(myrank)
       DO 5000
 C     
           CALL DDSYNC
@@ -1924,6 +1950,14 @@ C
 C
  5000 CONTINUE
  5100 CONTINUE
+      if (myrank .eq. 0) sscfake = SSC_MARK_STOP(myrank)
+      if (myrank .ne. 0) sscfake = SSC_MARK_STOP2(myrank)
+      mkrte = MPI_WTIME()
+      IF(myrank.EQ.0) THEN
+              write(*,"(A,F10.6,A)") "Walltime of the main kernel: ",
+     &                               mkrte - mkrts, " sec"
+              write(*,*) sscfake
+      ENDIF
       TIME_STOP(TM_MAIN_LOOP)
 C
       WRITE(IUT6,*) BLANK
diff --git a/src/make_setting b/src/make_setting
index d329411..08f5fc2 100644
--- a/src/make_setting
+++ b/src/make_setting
@@ -7,8 +7,9 @@ DEFINE += -DNO_REFINER
 # timing option
 DEFINE += -DPROF_MAPROF
 
-CFLAGS += $(DEFINE) -O3 -xHost -mcmodel=large -shared-intel
-FFLAGS += $(DEFINE) -O3 -xHost -mcmodel=large -shared-intel
+CFLAGS += $(DEFINE) -O3 -ipo -xHost -mcmodel=large -shared-intel -I${ADVISOR_2018_DIR}/include
+FFLAGS += $(DEFINE) -O3 -ipo -xHost -mcmodel=large -shared-intel
+LIBS += -L${ADVISOR_2018_DIR}/lib64 -littnotify
 
 
 ifeq (, $(findstring -DNO_METIS, $(FFLAGS)))
diff --git a/src/ssc.c b/src/ssc.c
new file mode 100644
index 0000000..31652a1
--- /dev/null
+++ b/src/ssc.c
@@ -0,0 +1,24 @@
+#include <ittnotify.h>
+#include <signal.h>
+#include <stdlib.h>
+#define STARTSDE {if(getenv("PCMPID")) kill(atoi(getenv("PCMPID")),SIGUSR1); __itt_resume(); __SSC_MARK(0x111);}
+#define START2SDE {__itt_resume(); __SSC_MARK(0x111);}
+#define STOPSDE {__SSC_MARK(0x222); __itt_pause(); if(getenv("PCMPID")) kill(atoi(getenv("PCMPID")), SIGUSR1);}
+#define STOP2SDE {__SSC_MARK(0x222); __itt_pause();}
+
+int ssc_mark_start (int x) {
+	STARTSDE;
+	return (x << 0x1);
+}
+int ssc_mark_start2 (int x) {
+	STAR2TSDE;
+	return (x << 0x1);
+}
+int ssc_mark_stop (int x) {
+	STOPSDE;
+	return (x >> 0x2);
+}
+int ssc_mark_stop2 (int x) {
+	STOP2SDE;
+	return (x >> 0x2);
+}
-- 
1.8.3.1

