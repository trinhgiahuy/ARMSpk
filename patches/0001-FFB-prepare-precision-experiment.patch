From a58eb8ca57d1a9b2c2f2c5eb277114fcc89c8904 Mon Sep 17 00:00:00 2001
From: Jens Domke <domke.j.aa@m.titech.ac.jp>
Date: Fri, 23 Feb 2018 02:38:26 +0900
Subject: [PATCH 1/1] FFB: prepare precision experiment

Signed-off-by: Jens Domke <domke.j.aa@m.titech.ac.jp>
---
 .gitignore            |  2 ++
 src/Makefile          |  2 +-
 src/ffb_mini_main.F90 | 17 ++++++++++++++++-
 src/les3x.F           | 13 ++++++++++++-
 src/make_setting      |  4 ++--
 src/ssc.c             | 12 ++++++++++++
 6 files changed, 45 insertions(+), 5 deletions(-)
 create mode 100644 src/ssc.c

diff --git a/.gitignore b/.gitignore
index 32dbb91..7b1856c 100644
--- a/.gitignore
+++ b/.gitignore
@@ -4,6 +4,8 @@
 *.log
 *.a
 
+bin/
+
 src/param.h
 
 test/BOUN.*
diff --git a/src/Makefile b/src/Makefile
index 0f46f89..a5166c1 100644
--- a/src/Makefile
+++ b/src/Makefile
@@ -32,7 +32,7 @@ OBJS = \
   rfname.o sethex.o srfexx.o          subcnv.o \
            vel3d1.o vel3d2.o          \
   mfname.o \
-  miniapp_util.o
+  miniapp_util.o ssc.o
 
 ifeq (, $(findstring -DNO_METIS, $(FFLAGS)))
 OBJS += metis_wrapper.o
diff --git a/src/ffb_mini_main.F90 b/src/ffb_mini_main.F90
index 060f4d4..2d5b188 100644
--- a/src/ffb_mini_main.F90
+++ b/src/ffb_mini_main.F90
@@ -1,7 +1,18 @@
 program ffb_mini
   use mpi
   use makemesh
+
+  use, intrinsic :: iso_c_binding
   implicit none
+  interface
+  subroutine SSC_MARK_START ( ) bind ( c )
+  !!!DEC$ ATTRIBUTES C:: SSC_MARK_START
+  end subroutine
+  subroutine SSC_MARK_STOP ( ) bind ( c )
+  !!!DEC$ ATTRIBUTES C:: SSC_MARK_STOP
+  end subroutine
+  end interface
+
 
   integer :: ierr
   include 'param.h'
@@ -30,6 +41,8 @@ program ffb_mini
   character(60) :: color_partsize = ""
   character(60) :: unroll = ""
 
+  call SSC_MARK_STOP()
+
   call MPI_Init(ierr)
   call MPI_Comm_rank(MPI_COMM_WORLD, myrank, ierr)
   call MPI_Comm_size(MPI_COMM_WORLD, nprocs, ierr)
@@ -110,7 +123,9 @@ program ffb_mini
       write(*, '(/,a,/)') '... done'
   end if
 
-  call LES3X(file_parm)
+  call LES3X(file_parm, myrank)
+
+  call SSC_MARK_START()
 
 contains
 
diff --git a/src/les3x.F b/src/les3x.F
index bf9d6fa..2906c5d 100644
--- a/src/les3x.F
+++ b/src/les3x.F
@@ -15,10 +15,13 @@ C THERMO-FLUID ANALYSIS SOLVERS FOR LARGE-SCALE-ASSEMBLY               C
 C                                                                      C
 C======================================================================C
 C*    PROGRAM LES3X
-      SUBROUTINE LES3X(FILEIN)
+      SUBROUTINE LES3X(FILEIN,myrank)
 #include "timing.h"
       IMPLICIT NONE 
 C
+      include 'mpif.h'
+      real(8) :: mkrts, mkrte
+      INTEGER*4 myrank
       CHARACTER*(*) FILEIN
 C
       INTEGER*4 N0,N1,N2
@@ -1781,6 +1784,8 @@ C
       WRITE(IUT6,*) BLANK
       WRITE(IUT6,*) ' ** NOW ENTERING TIME MARCH LOOP **'
       TIME_START(TM_MAIN_LOOP)
+      mkrts = MPI_WTIME()
+      call SSC_MARK_START()
       DO 5000
 C     
           CALL DDSYNC
@@ -1924,6 +1929,12 @@ C
 C
  5000 CONTINUE
  5100 CONTINUE
+      call SSC_MARK_STOP()
+      mkrte = MPI_WTIME()
+      IF(myrank.EQ.1) THEN
+              write(*,"(A,F10.6,A)") "Walltime of the main kernel: ",
+     &                               mkrte - mkrts, " sec"
+      ENDIF
       TIME_STOP(TM_MAIN_LOOP)
 C
       WRITE(IUT6,*) BLANK
diff --git a/src/make_setting b/src/make_setting
index d329411..bbad7ed 100644
--- a/src/make_setting
+++ b/src/make_setting
@@ -7,8 +7,8 @@ DEFINE += -DNO_REFINER
 # timing option
 DEFINE += -DPROF_MAPROF
 
-CFLAGS += $(DEFINE) -O3 -xHost -mcmodel=large -shared-intel
-FFLAGS += $(DEFINE) -O3 -xHost -mcmodel=large -shared-intel
+CFLAGS += $(DEFINE) -O3 -ipo -xHost -mcmodel=large -shared-intel
+FFLAGS += $(DEFINE) -O3 -ipo -xHost -mcmodel=large -shared-intel
 
 
 ifeq (, $(findstring -DNO_METIS, $(FFLAGS)))
diff --git a/src/ssc.c b/src/ssc.c
new file mode 100644
index 0000000..87a4aee
--- /dev/null
+++ b/src/ssc.c
@@ -0,0 +1,12 @@
+void ssc_mark_start (void) {
+	__SSC_MARK(0x111);
+}
+void ssc_mark_stop (void) {
+	__SSC_MARK(0x222);
+}
+void ssc_mark_start_ (void) {
+	__SSC_MARK(0x111);
+}
+void ssc_mark_stop_ (void) {
+	__SSC_MARK(0x222);
+}
-- 
1.8.3.1

